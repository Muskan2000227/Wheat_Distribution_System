<script>
if (localStorage.getItem("loggedIn") !== "true") {
  window.location.href = "login.html";
}
</script>


<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wheat Distribution ‚Äî Table View</title>
<style>
  body { font-family: Arial, sans-serif; padding:14px; max-width:1100px; margin:0 auto; }
  header { display:flex; align-items:baseline; gap:12px; margin-bottom:12px; }
  h2 { margin:0; }
  .controls { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; align-items:center; }
  input, select, button { padding:8px; border-radius:6px; border:1px solid #ccc; }
  input[type="search"]{ min-width:220px; flex:1; }
  table { width:100%; border-collapse:collapse; margin-top:8px; }
  th, td { text-align:left; padding:8px 10px; border-bottom:1px solid #eee; vertical-align:middle; }
  th { background:#fafafa; position:sticky; top:0; z-index:1; }
  tr.row-no { background:#fff8f8; } /* optional highlight for not-taken */
  .okbtn { background:#d4edda; border:1px solid #c3e6cb; padding:6px 8px; border-radius:6px; cursor:pointer; }
  .nobtn { background:#f8d7da; border:1px solid #f5c6cb; padding:6px 8px; border-radius:6px; cursor:pointer; }
  .disabled { opacity:0.6; cursor:default; pointer-events:none; }
  .small { font-size:13px; color:#555; }
  .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:6px; }
  @media (max-width:880px){
    th:nth-child(4), td:nth-child(4), th:nth-child(6), td:nth-child(6) { display:none; } /* hide some cols on small screens */
  }
</style>

<!-- UMD build so file:// works on phones -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
</head>
<body>

<style>
  .navbar {
    width: 100%;
    background: #222;
    color: white;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .navbar-title { font-size: 20px; font-weight: bold; }
  .hamburger { font-size: 28px; cursor: pointer; }

  .menu {
    display: none;
    flex-direction: column;
    background: #333;
    width: 100%;
  }

  .menu a {
    color: white;
    padding: 12px;
    text-decoration: none;
    border-bottom: 1px solid #444;
  }
  .menu a:hover { background: #444; }
</style>

<div class="navbar">
  <div class="navbar-title">Wheat Distribution</div>
  <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
</div>

<div id="navMenu" class="menu">
  <a href="add.html">‚ûï Add Record</a>
  <a href="edit.html">‚úèÔ∏è Edit Records</a>
  <a href="delete.html">üóëÔ∏è Delete</a>
  <a href="wheat.html">üìã View Members</a>
  <a href="admin.html">‚öô Admin</a>
</div>

<script>
function toggleMenu() {
  const m = document.getElementById("navMenu");
  m.style.display = m.style.display === "flex" ? "none" : "flex";
}
</script>




<h2 style="margin-bottom: 20px;"></h2>

<div class="controls">
  <input id="search" type="search" placeholder="Search name or phone" />
  <input id="rcSearch" placeholder="Search Ration Card (exact or partial)" style="width:240px" />
  <select id="filter">
    <option value="">All</option>
    <option value="no">Not taken</option>
    <option value="ok">Taken</option>
  </select>
  <button id="findBtn">Find</button>
  <button id="reload">Reload</button>
</div>

<div class="topbar">
  <div class="small" id="summary">Loading...</div>
  <div class="small">Rows: <span id="count">0</span></div>
</div>

<!-- Table container -->
<div style="overflow:auto">
  <table id="membersTable" aria-describedby="summary">
    <thead>
      <tr>
        <th style="width:28%;">Name</th>
        <th style="width:8%;">Members</th>
        <th style="width:14%;">Phone</th>
        <th style="width:14%;">Ration Card</th>
        <th style="width:8%;">Status</th>
        <th style="width:16%;">Updated At</th>
        <th style="width:12%;">Action</th>
      </tr>
    </thead>
    <tbody id="tableBody">
      <tr><td colspan="7" class="small">Loading...</td></tr>
    </tbody>
  </table>
</div>

<script>
/* ---------- REPLACE THESE VALUES ---------- */
const SUPABASE_URL = "https://csnmofxxrmvxzhdkgroc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzbm1vZnh4cm12eHpoZGtncm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MjA4NTgsImV4cCI6MjA4MDQ5Njg1OH0.NcMTpVUu7LgePDvkrUGo7eIF-j88DF4XNMBWRY20QPo";
/* ------------------------------------------ */

if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
  document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="small">Please configure SUPABASE_URL and SUPABASE_ANON_KEY in the HTML.</td></tr>';
  throw new Error('Missing Supabase config');
}

const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const searchInput = document.getElementById('search');
const rcInput = document.getElementById('rcSearch');
const filterSelect = document.getElementById('filter');
const findBtn = document.getElementById('findBtn');
const reloadBtn = document.getElementById('reload');
const tableBody = document.getElementById('tableBody');
const countEl = document.getElementById('count');
const summaryEl = document.getElementById('summary');

async function loadMembers({ q='', rc='', status='' } = {}) {
  try {
    let res;
    if (rc) {
      res = await db.from('members').select('*').ilike('ration_card_number', `%${rc}%`).order('name', { ascending: true });
    } else if (q) {
      const esc = q.replace(/%/g, '\\%').replace(/'/g, "''");
      res = await db.from('members')
        .select('*')
        .or(`name.ilike.%${esc}%,phone.ilike.%${esc}%,ration_card_number.ilike.%${esc}%`)
        .order('name', { ascending: true });
    } else {
      res = await db.from('members').select('*').order('name', { ascending: true });
    }

    if (res.error) throw res.error;
    let data = res.data || [];
    if (status) data = data.filter(r => r.status === status);

    renderTable(data);
    updateSummary(data);
  } catch (err) {
    console.error('Error loading members', err);
    tableBody.innerHTML = `<tr><td colspan="7" class="small">Error loading data. Check console for details.</td></tr>`;
    summaryEl.textContent = 'Error';
    countEl.textContent = '0';
  }
}

function renderTable(data) {
  if (!data || !data.length) {
    tableBody.innerHTML = '<tr><td colspan="7" class="small">No records found.</td></tr>';
    countEl.textContent = '0';
    return;
  }

  countEl.textContent = data.length;
  tableBody.innerHTML = '';

  data.forEach(row => {
    const tr = document.createElement('tr');
    if (row.status === 'no') tr.classList.add('row-no');

    const updatedAt = row.updated_at ? new Date(row.updated_at).toLocaleString() : '-';

    tr.innerHTML = `
      <td><strong>${escapeHtml(row.name || '')}</strong><div class="small">${escapeHtml(row.ration_card_number || '')}</div></td>
      <td>${row.total_members || 0}</td>
      <td>${escapeHtml(row.phone || '')}</td>
      <td>${escapeHtml(row.ration_card_number || '')}</td>
      <td>${escapeHtml(row.status || '')}</td>
      <td>${escapeHtml(updatedAt)}</td>
      <td>
        <button class="okbtn" data-id="${row.id}" ${row.status==='ok'?'disabled aria-disabled="true"':''}>OK</button>
        <button class="nobtn" data-id="${row.id}" ${row.status==='no'?'disabled aria-disabled="true"':''}>NO</button>
      </td>
    `;
    tableBody.appendChild(tr);
  });
}

function updateSummary(data){
  const taken = data.filter(d => d.status === 'ok').length;
  const notTaken = data.filter(d => d.status === 'no').length;
  summaryEl.textContent = `Showing ${data.length} rows ‚Äî Taken: ${taken} ‚Ä¢ Not taken: ${notTaken}`;
}

async function updateStatus(id, status) {
  try {
    const { error } = await db.from('members').update({
      status,
      updated_by: 'FieldUser',
      updated_at: new Date().toISOString()
    }).eq('id', id);

    if (error) throw error;
    // refresh current view
    triggerLoad();
  } catch (err) {
    alert('Update failed: ' + (err.message || err));
    console.error(err);
  }
}

// delegate click events for OK/NO buttons
document.addEventListener('click', (e) => {
  const btn = e.target.closest('button.okbtn, button.nobtn');
  if (!btn) return;
  const id = btn.dataset.id;
  if (!id) return;
  if (btn.classList.contains('okbtn')) updateStatus(id, 'ok');
  else updateStatus(id, 'no');
});

// controls
findBtn.addEventListener('click', triggerLoad);
reloadBtn.addEventListener('click', () => {
  searchInput.value = '';
  rcInput.value = '';
  filterSelect.value = '';
  loadMembers({});
});

// Enter key triggers find
[searchInput, rcInput].forEach(inp => inp.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') triggerLoad();
}));

function triggerLoad() {
  const q = searchInput.value.trim();
  const rc = rcInput.value.trim();
  const status = filterSelect.value;
  loadMembers({ q, rc, status });
}

// show all on load
searchInput.value = '';
rcInput.value = '';
filterSelect.value = '';
loadMembers({});
// end
function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>
</body>
</html>

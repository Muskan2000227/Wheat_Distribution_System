<script>
if (localStorage.getItem("loggedIn") !== "true") {
  window.location.href = "login.html";
}
</script>


<!doctype html>
<html>
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Delete Member</title>
<style>body{font-family:Arial;padding:12px;max-width:800px;margin:auto}input,button{padding:8px;border:1px solid #ccc;border-radius:6px} table{width:100%;border-collapse:collapse}td,th{padding:6px;border-bottom:1px solid #eee}</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
</head>
<body>
<style>
  .navbar {
    width: 100%;
    background: #222;
    color: white;
    padding: 12px 16px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .navbar-title { font-size: 20px; font-weight: bold; }
  .hamburger { font-size: 28px; cursor: pointer; }

  .menu {
    display: none;
    flex-direction: column;
    background: #333;
    width: 100%;
  }

  .menu a {
    color: white;
    padding: 12px;
    text-decoration: none;
    border-bottom: 1px solid #444;
  }
  .menu a:hover { background: #444; }
</style>

<div class="navbar">
  <div class="navbar-title">Wheat Distribution</div>
  <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
</div>

<div id="navMenu" class="menu">
  <a href="add.html">‚ûï Add Record</a>
  <a href="edit.html">‚úèÔ∏è Edit Records</a>
  <a href="delete.html">üóëÔ∏è Delete</a>
  <a href="wheat.html">üìã View Members</a>
  <a href="admin.html">‚öô Admin</a>
</div>

<script>
function toggleMenu() {
  const m = document.getElementById("navMenu");
  m.style.display = m.style.display === "flex" ? "none" : "flex";
}
</script>



<h2>Delete Member</h2>

<div style="display:flex;gap:8px;margin-bottom:8px">
  <input id="q" placeholder="Search by ration card or name" style="flex:1" />
  <button id="search">Search</button>
  <button id="reload">Show all</button>
</div>

<table id="results"><thead><tr><th>Name</th><th>RC</th><th>Phone</th><th>Members</th><th>Action</th></tr></thead><tbody><tr><td colspan="5">No results</td></tr></tbody></table>

<div id="msg" style="color:crimson;margin-top:8px"></div>

<script>
/* ---------- REPLACE THESE VALUES ---------- */
const SUPABASE_URL = "https://csnmofxxrmvxzhdkgroc.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNzbm1vZnh4cm12eHpoZGtncm9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MjA4NTgsImV4cCI6MjA4MDQ5Njg1OH0.NcMTpVUu7LgePDvkrUGo7eIF-j88DF4XNMBWRY20QPo";
/* ------------------------------------------ */
if(!SUPABASE_URL||!SUPABASE_ANON_KEY){ document.getElementById('msg').textContent='Configure keys'; throw 0; }
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const tbody = document.querySelector('#results tbody');

async function performSearch(q='') {
  tbody.innerHTML = '<tr><td colspan="5">Searching...</td></tr>';
  try {
    if(!q) {
      const { data, error } = await db.from('members').select('*').order('name',{ascending:true});
      if(error) throw error; render(data||[]); return;
    }
    const esc = q.replace(/%/g,'\\%').replace(/'/g,"''");
    const { data, error } = await db.from('members').select('*').or(`ration_card_number.ilike.%${esc}%,name.ilike.%${esc}%`).order('name',{ascending:true});
    if(error) throw error; render(data||[]);
  } catch(err) { console.error(err); tbody.innerHTML = '<tr><td colspan="5">Error</td></tr>'; }
}

function render(rows) {
  if(!rows.length) { tbody.innerHTML = '<tr><td colspan="5">No rows</td></tr>'; return; }
  tbody.innerHTML = '';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escape(r.name)}</td><td>${escape(r.ration_card_number)}</td><td>${escape(r.phone||'')}</td><td>${r.total_members||0}</td>
      <td><button data-id="${r.id}" class="del">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

function escape(s=''){ return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

document.getElementById('search').addEventListener('click', ()=>performSearch(document.getElementById('q').value.trim()));
document.getElementById('reload').addEventListener('click', ()=>performSearch(''));

tbody.addEventListener('click', async (e)=> {
  const btn = e.target.closest('button.del'); if(!btn) return;
  const id = btn.dataset.id;
  if(!confirm('Delete this row? This cannot be undone.')) return;
  try {
    const { error } = await db.from('members').delete().eq('id', id);
    if(error) return document.getElementById('msg').textContent = 'Delete failed: '+error.message;
    document.getElementById('msg').style.color='green'; document.getElementById('msg').textContent='Deleted';
    performSearch(document.getElementById('q').value.trim());
  } catch(err){ document.getElementById('msg').textContent='Error: '+err.message; console.error(err); }
});
</script>
</body>
</html>
